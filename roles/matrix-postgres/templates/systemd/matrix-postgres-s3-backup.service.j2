#jinja2: lstrip_blocks: "True"

[Unit]
Description=Backup service for Matrix Postgres Server

[Service]
Environment=AWS_BUCKET_NAME={{ matrix_postgres_s3_backup_bucket }}
Type=oneshot
ExecStartPre=/bin/sh -c '/usr/bin/docker run --rm \
				--network={{ matrix_docker_network }} \
				--env-file={{ matrix_postgres_base_path }}/env-postgres-psql \
				--user={{ matrix_user_uid }}:{{ matrix_user_gid }} \
				{{ matrix_postgres_docker_image_to_use }} \
				pg_dumpall -h matrix-postgres | gzip -c > /tmp/postgres-backup.sql.gz'

ExecStart=/bin/sh -c 'aws s3 cp /tmp/postgres-backup.sql.gz ${AWS_BUCKET_NAME}$$(date +%%Y-%%m-%%d)/ && rm /tmp/postgres-backup.sql.gz'
Group=systemd-journal